<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/core/slides.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/core/slides.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Load the slides object form the YAML file format and process it.
 * @module @bldr/core/slides
 */

'use strict'

/***********************************************************************
 *
 **********************************************************************/

/**
 * A raw slide object or a raw slide string.
 *
 * If a string is obtained, it should be the name of a master slide.
 * This type is the direct input of the markdown configuration file
 * converted to a Javascript types.
 *
 * # Object with one property:
 *
 *     - markdown: Some text
 *
 * # Object with multiple properties:
 *
 *     - title: A quote
 *       quote:
 *         author: Goehte
 *         text: lol
 *
 * # String:
 *
 *     - camera
 *
 * @typedef rawSlideData
 * @type {(object|string)}
 */

/**
 * Various types of data to render a slide.
 * @typedef rawSlideData
 * @type {(boolean|number|string|array|object)}
 */

/**
 * Step data indexed by the step number begining with 1.
 *
 *     {
 *       1: {misc},
 *       2: {misc},
 *       3: {misc}
 *     }
 *
 * @typedef stepData
 * @type {object}
 * @property {stepData.1} stepDataEntry Misc step data
 * @property {stepData.2} stepDataEntry Misc step data
 * @property {stepData.3} stepDataEntry Misc step data
 */

/***********************************************************************
 *
 **********************************************************************/

/**
 * Some masters support steps. Steps are switched by the up and down
 * arrow keys. Steps are the second level in the hierachy of state
 * changes. On the first level are slides.
 */
class StepSwitcher {
  /**
   * @param {module:@bldr/core/slides~Slide} slide The object
   *   representation of one slide.
   * @param {module:@bldr/core~Environment} env Low level
   *   environment data.
   */
  constructor (slide, env) {
    /**
     * The object representation of one slide.
     * @type {module:@bldr/core/slides~Slide}
     */
    this.slide = slide

    /**
     * Low level environment data.
     * @type {module:@bldr/core~Environment}
     */
    this.env = env

    /**
     * The normalized master object derived from the master slide.
     * @type {module:@bldr/core/masters~Master}
     */
    this.master = slide.master

    /**
     * The HTML-Button-Element that triggers the previous step.
     * @type {object}
     */
    this.elements = {
      prev: this.env.document.getElementById('nav-step-prev'),
      next: this.env.document.getElementById('nav-step-next')
    }

    /**
     * Object to store data for the individual steps. The step data
     * should be indexed by the step number.
     * @type {module:@bldr/core/slides~stepData}
     */
    this.stepData = false

    /**
     * @type {boolean}
     */
    this.stepSupport = false

    /**
     * The current step number. (Default: 0)
     * @type {integer}
     */
    this.no = 0

    /**
     * Indicates if a slide was already visited.
     * @type {boolean}
     */
    this.visited = false
  }

  /**
   *
   */
  setButtonsVisibility_ (state) {
    this.elements.prev.style.visibility = state
    this.elements.next.style.visibility = state
  }

  /**
   *
   */
  setup_ (stepData) {
    if (stepData) {
      this.stepData = stepData
      this.count = Object.keys(stepData).length
      this.stepSupport = this.count > 1
    }
  }

  /**
   *
   */
  visit () {
    this.setup_(
      this.master.initStepsEveryVisit(this.env.document, this.slide, this.env.config)
    )
    if (!this.visited) {
      this.setup_(
        this.master.initSteps(this.env.document, this.slide, this.env.config)
      )
      this.visited = true
      this.no = 1
    }

    if (this.stepSupport) {
      this.setByNo(this.no)
      this.setButtonsVisibility_('visible')
    } else {
      this.setButtonsVisibility_('hidden')
    }
  }

  /**
   *
   */
  setByNo (no) {
    this.master.setStepByNo(no, this.count, this.stepData, this.env.document)
  }

  /**
   *
   */
  prev () {
    if (this.stepSupport) {
      if (this.no === 1) {
        this.no = this.count
      } else {
        this.no--
      }
      this.setByNo(this.no)
    }
  }

  /**
   *
   */
  next () {
    if (this.stepSupport) {
      if (this.no === this.count) {
        this.no = 1
      } else {
        this.no++
      }
      this.setByNo(this.no)
    }
  }
}

/***********************************************************************
 *
 **********************************************************************/

class SlideData {
  /**
   * @param {module:@bldr/core/slides~rawSlideData} rawSlideData
   *   Various types of data to render a slide.
   * @param {module:@bldr/core~Environment} env Low level
   *   environment data.
   */
  constructor (rawSlideData, env) {
    /**
     * Various types of data to render a slide.
     * @type {module:@bldr/core/slides~rawSlideData}
     */
    this.rawSlideData = Object.assign({}, rawSlideData)

    /**
     * The name of a theme.
     * @type {string}
     */
    this.themeName = false

    /**
     * The name of the master slide.
     * @type {string}
     */
    this.masterName = false

    /**
     * Data in various types to pass to a master slide.
     * @type {module:@bldr/core/masters~rawMasterData}
     */
    this.rawMasterData = false

    // string
    if (typeof rawSlideData === 'string') {
      let { masterName, rawMasterData } = this.pullMasterfromString_(
        rawSlideData, env.masters.all
      )
      rawSlideData = {}
      this.masterName = masterName
      this.rawMasterData = rawMasterData
    // object
    } else if (typeof rawSlideData === 'object' &amp;&amp; !Array.isArray(rawSlideData)) {
      let { masterName, rawMasterData } = this.pullMasterfromObject_(
        rawSlideData, env.masters.all
      )
      this.masterName = masterName
      this.rawMasterData = rawMasterData
      this.themeName = this.pullTheme_(
        rawSlideData, env.themes.all
      )
    // something else
    } else {
      throw Error(`Unsupported input type “${this.getType_(rawSlideData)}” on input data: ${this.toString_(rawSlideData)}`)
    }

    if (Object.keys(rawSlideData).length > 0) {
      throw Error(`Unknown slide properties: ${this.toString_(rawSlideData)}`)
    }
  }

  /**
   *
   */
  pullProperty_ (rawSlideData, property) {
    if (rawSlideData.hasOwnProperty(property)) {
      const out = rawSlideData[property]
      delete rawSlideData[property]
      return out
    } else {
      return false
    }
  }

  /**
   * Get the intersection between all master names and the slide keys.
   *
   * This method can be used to check that a slide object uses only
   * one master slide.
   *
   * @param {array} array1
   * @param {array} array2
   * @return {array} The intersection as an array
   */
  intersect_ (array1, array2) {
    return array1.filter((n) => array2.includes(n))
  }

  /**
   *
   */
  pullMasterfromString_ (rawSlideData, masters) {
    if (masters.includes(rawSlideData)) {
      return {
        masterName: rawSlideData,
        rawMasterData: true
      }
    } else {
      throw Error(`Unknown master “${rawSlideData}” specified as string`)
    }
  }

  /**
   *
   */
  pullMasterfromObject_ (rawSlideData, masterNames) {
    let intersection = this.intersect_(
      masterNames,
      Object.keys(rawSlideData)
    )

    if (intersection.length === 0) {
      throw Error(`No master slide found: ${this.toString_(rawSlideData)}`)
    }

    if (intersection.length > 1) {
      throw Error(`Each slide must have only one master slide: ${this.toString_(rawSlideData)}`)
    }
    let masterName = intersection[0]
    let rawMasterData = rawSlideData[masterName]
    this.pullProperty_(rawSlideData, masterName)

    return {
      masterName: masterName,
      rawMasterData: rawMasterData
    }
  }

  /**
   *
   */
  pullTheme_ (rawSlideData, themeNames) {
    if (!rawSlideData.hasOwnProperty('theme')) {
      return false
    } else if (themeNames.includes(rawSlideData.theme)) {
      let theme = rawSlideData.theme
      this.pullProperty_(rawSlideData, 'theme')
      return theme
    } else {
      throw Error(`Unkown theme: “${this.toString_(rawSlideData.theme)}”`)
    }
  }

  /**
   *
   */
  toString_ (rawSlideData) {
    if (rawSlideData === null) {
      return 'null'
    } else if (!rawSlideData) {
      return typeof rawSlideData
    } else if (typeof rawSlideData === 'string') {
      return rawSlideData
    } else if (Array.isArray(rawSlideData)) {
      return rawSlideData.toString()
    } else {
      return JSON.stringify(rawSlideData)
    }
  }

  /**
   *
   */
  getType_ (rawSlideData) {
    if (Array.isArray(rawSlideData)) {
      return 'array'
    } else if (rawSlideData === null) {
      return 'null'
    } else {
      return typeof rawSlideData
    }
  }
}

/***********************************************************************
 *
 **********************************************************************/

/**
 *
 */
class Slide {
  /**
   * @param {module:@bldr/core~Environment} env Low level
   *   environment data.
   */
  constructor (rawSlideData, env) {
    /**
     * Low level environment data.
     * @type {module:@bldr/core~Environment}
     */
    this.env = env

    /**
     * Normalized slide data.
     * @type {module:@bldr/core/slides~SlideData}
     */
    this.slideData = new SlideData(rawSlideData, this.env)

    /**
     * @type {object}
     */
    this.elements = {
      slide: this.env.document.getElementById('slide-content'),
      modal: this.env.document.getElementById('modal-content')
    }

    /**
     * The normalized master object derived from the master slide.
     * @type {module:@bldr/core/masters~Master}
     */
    this.master = this.env.masters[this.slideData.masterName]

    /**
     * Normalized master data.
     * @type {module:@bldr/core/masters~masterData}
     */
    this.masterData = this.master
      .normalizeData(this.slideData.rawMasterData, this.env.config)

    /**
     * The instantiated object derived from the class “StepSwitcher()”
     * @type {module:@bldr/core/slides~StepSwitcher}
     */
    this.steps = new StepSwitcher(this, this.env)

    /**
     * A HTML div element, which covers the complete slide area to
     * a void flickering, when new CSS styles are loaded.
     *
     * @type {object}
     */
    this.cover = this.env.document.getElementById('cover')
  }

  /**
   * Set the background color of the “cover” DIV element.
   *
   * @param {string} color A CSS color information.
   * @param {number} zIndex A CSS color information.
   */
  setCover_ (color, zIndex) {
    this.cover.style.backgroundColor = color
    this.cover.style.zIndex = zIndex
  }

  /**
   *
   */
  setDataset_ () {
    let dataset = this.env.document.body.dataset
    dataset.centerVertically = this.master.config.centerVertically
    dataset.margin = this.master.config.margin
    dataset.master = this.master.name
    if (this.slideData.themeName) {
      dataset.theme = this.slideData.themeName
    } else {
      dataset.theme = this.master.config.theme
    }
  }

  /**
   *
   */
  setModal_ () {
    this.elements.modal.innerHTML = this.master.modalHTML()
  }

  /**
   *
   */
  setMain_ () {
    this.elements.slide.innerHTML = this.master.mainHTML(
      this,
      this.env.config,
      this.env.document
    )
  }

  /**
   *
   */
  set (oldSlide) {
    if (oldSlide &amp;&amp; oldSlide.hasOwnProperty('master')) {
      this.env.masters[oldSlide.master.name]
        .cleanUp(this.env.document, oldSlide, this)
    }
    this.setCover_('black', 1)
    setTimeout(() => {
      this.setCover_('transparent', -1)
    }, 50)
    this.setDataset_()
    this.setMain_()
    this.setModal_()
    this.master.postSet(this, this.env.config, this.env.document)

    this.steps.visit()
  }
}

/***********************************************************************
 *
 **********************************************************************/

/**
 * Show a master slide without custom data.
 *
 * The displayed master slide is not part of the acutal presentation.
 * Not every master slide can be shown with this function. It muss be
 * possible to render the master slide without custom data.
 * No number is assigned to the master slide.
 *
 * @param {string} masterName Name of the master slide.
 * @param {module:@bldr/core/slides~rawSlideData} rawSlideData
 *   Various types of data to render a slide.
 * @param {module:@bldr/core~Environment} env Low level
 *   environment data.
 *
 * @return {module:@bldr/core/slides~Slide}
 */
exports.getInstantSlide = function (masterName, rawSlideData, env) {
  let rawSlide = {}
  if (!rawSlideData) {
    rawSlideData = true
  }
  rawSlide[masterName] = rawSlideData
  return new Slide(rawSlide, env)
}

/***********************************************************************
 *
 **********************************************************************/

/**
 * Parse the object representation of all slides.
 */
class Slides {
  /**
   * @param {module:@bldr/core~Environment} env Low level
   *   environment data.
   */
  constructor (env) {
    /**
     * Low level environment data.
     * @type {module:@bldr/core~Environment}
     */
    this.env = env

    /**
     * An array of raw slide objects.
     * @type {array}
     */
    this.rawSlides = this.env.config.slides
  }

  /**
   * &lt;pre>&lt;code>
   * {
   *   "1": {
   *     "no": 1,
   *     "master": "quote",
   *     "data": {
   *       "text": "Der Tag der Gunst ist wie der Tag der Ernte,\nman muss geschäftig sein sobald sie reift.\n",
   *       "author": "Johann Wolfgang von Goethe",
   *       "date": 1801
   *     }
   *   },
   *   "2": {
   *     "no": 2,
   *     "master": "question",
   *     "data": [
   *       {
   *         "question": "Wann starb Ludwig van Beethoven?",
   *         "answer": 1827
   *       }
   *     ]
   *   },
   *   "3": {
   *     "no": 3,
   *     "master": "person",
   *     "data": {
   *       "name": "Ludwig van Beethoven",
   *       "image": "beethoven.jpg"
   *     }
   *   }
   * }
   * &lt;/code>&lt;pre>
   * @return {object}
   */
  get () {
    let out = {}

    this.rawSlides.forEach((rawSlide, index) => {
      let slide = new Slide(rawSlide, this.env)
      slide.no = index + 1
      out[index + 1] = slide
    })

    return out
  }
}

/**
 * @param {module:@bldr/core~Environment} env Low level
 *   environment data.
 */
exports.getSlides = function (env) {
  return new Slides(env).get()
}

exports.Slide = Slide
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-@bldr_core.html">@bldr/core</a></li><li><a href="module-@bldr_core_masters.html">@bldr/core/masters</a></li><li><a href="module-@bldr_core_quick-start.html">@bldr/core/quick-start</a></li><li><a href="module-@bldr_core_slides.html">@bldr/core/slides</a></li><li><a href="module-@bldr_core_slides-switcher.html">@bldr/core/slides-switcher</a></li><li><a href="module-@bldr_core_themes.html">@bldr/core/themes</a></li><li><a href="module-@bldr_foundation-master.html">@bldr/foundation-master</a></li><li><a href="module-@bldr_foundation-master_config.html">@bldr/foundation-master/config</a></li><li><a href="module-@bldr_foundation-master_helper.html">@bldr/foundation-master/helper</a></li><li><a href="module-@bldr_foundation-master_media.html">@bldr/foundation-master/media</a></li><li><a href="module-@bldr_foundation-master_player.html">@bldr/foundation-master/player</a></li><li><a href="module-@bldr_master-audio.html">@bldr/master-audio</a></li><li><a href="module-@bldr_master-camera.html">@bldr/master-camera</a></li><li><a href="module-@bldr_master-editor.html">@bldr/master-editor</a></li><li><a href="module-@bldr_master-image.html">@bldr/master-image</a></li><li><a href="module-@bldr_master-markdown.html">@bldr/master-markdown</a></li><li><a href="module-@bldr_master-person.html">@bldr/master-person</a></li><li><a href="module-@bldr_master-question.html">@bldr/master-question</a></li><li><a href="module-@bldr_master-quote.html">@bldr/master-quote</a></li><li><a href="module-@bldr_master-svg.html">@bldr/master-svg</a></li><li><a href="module-@bldr_master-video.html">@bldr/master-video</a></li><li><a href="module-@bldr_master-website.html">@bldr/master-website</a></li><li><a href="module-@bldr_songbook-base.html">@bldr/songbook-base</a></li><li><a href="module-@bldr_songbook-cli.html">@bldr/songbook-cli</a></li><li><a href="module-@bldr_songbook-electron-app.html">@bldr/songbook-electron-app</a></li><li><a href="module-@bldr_songbook-intermediate-files.html">@bldr/songbook-intermediate-files</a></li><li><a href="module-@bldr_test-helper.html">@bldr/test-helper</a></li><li><a href="module-baldr.html">baldr</a></li><li><a href="module-baldr_render.html">baldr/render</a></li></ul><h3>Classes</h3><ul><li><a href="ModalManager.html">ModalManager</a></li><li><a href="ModalWindowElement.html">ModalWindowElement</a></li><li><a href="module-@bldr_core_masters-Master.html">Master</a></li><li><a href="module-@bldr_core_masters-Masters.html">Masters</a></li><li><a href="module-@bldr_core_quick-start-QuickStart.html">QuickStart</a></li><li><a href="module-@bldr_core_quick-start-QuickStartEntry.html">QuickStartEntry</a></li><li><a href="module-@bldr_core_slides-switcher-SlidesSwitcher.html">SlidesSwitcher</a></li><li><a href="module-@bldr_core_slides-Slide.html">Slide</a></li><li><a href="module-@bldr_core_slides-SlideData.html">SlideData</a></li><li><a href="module-@bldr_core_slides-Slides.html">Slides</a></li><li><a href="module-@bldr_core_slides-StepSwitcher.html">StepSwitcher</a></li><li><a href="module-@bldr_core_themes-Themes.html">Themes</a></li><li><a href="module-@bldr_core-Environment.html">Environment</a></li><li><a href="module-@bldr_core-ShowRunner.html">ShowRunner</a></li><li><a href="module-@bldr_foundation-master_config-Config.html">Config</a></li><li><a href="module-@bldr_foundation-master_media-FileInfo.html">FileInfo</a></li><li><a href="module-@bldr_foundation-master_media-Media.html">Media</a></li><li><a href="module-@bldr_foundation-master_player-Player.html">Player</a></li><li><a href="module-@bldr_master-audio-Audio.html">Audio</a></li><li><a href="module-@bldr_master-video-VideoPlayer.html">VideoPlayer</a></li><li><a href="module-@bldr_songbook-base-AlphabeticalSongsTree.html">AlphabeticalSongsTree</a></li><li><a href="module-@bldr_songbook-base-Folder.html">Folder</a></li><li><a href="module-@bldr_songbook-base-Library.html">Library</a></li><li><a href="module-@bldr_songbook-base-Song.html">Song</a></li><li><a href="module-@bldr_songbook-base-SongMetaData.html">SongMetaData</a></li><li><a href="module-@bldr_songbook-base-SongMetaDataCombined.html">SongMetaDataCombined</a></li><li><a href="module-@bldr_songbook-intermediate-files-FileMonitor.html">FileMonitor</a></li><li><a href="module-@bldr_songbook-intermediate-files-IntermediateLibrary.html">IntermediateLibrary</a></li><li><a href="module-@bldr_songbook-intermediate-files-IntermediateSong.html">IntermediateSong</a></li><li><a href="module-@bldr_songbook-intermediate-files-PianoFilesCountTree.html">PianoFilesCountTree</a></li><li><a href="module-@bldr_songbook-intermediate-files-PianoScore.html">PianoScore</a></li><li><a href="module-@bldr_songbook-intermediate-files-Sqlite.html">Sqlite</a></li><li><a href="module-@bldr_songbook-intermediate-files-TextFile.html">TextFile</a></li><li><a href="module-@bldr_test-helper-Spectron.html">Spectron</a></li><li><a href="PackageElectronApp.html">PackageElectronApp</a></li><li><a href="Seats.html">Seats</a></li><li><a href="SongbookSearchElement.html">SongbookSearchElement</a></li><li><a href="SongSlideElement.html">SongSlideElement</a></li><li><a href="TableOfContentsElement.html">TableOfContentsElement</a></li></ul><h3>Global</h3><ul><li><a href="global.html#bindButtons">bindButtons</a></li><li><a href="global.html#bindShortcuts">bindShortcuts</a></li><li><a href="global.html#defineCustomElements">defineCustomElements</a></li><li><a href="global.html#fakeSong">fakeSong</a></li><li><a href="global.html#fakeSongs">fakeSongs</a></li><li><a href="global.html#main">main</a></li><li><a href="global.html#read">read</a></li><li><a href="global.html#readPathSegments">readPathSegments</a></li><li><a href="global.html#removeANSI">removeANSI</a></li><li><a href="global.html#setNextSong">setNextSong</a></li><li><a href="global.html#setPreviousSong">setPreviousSong</a></li><li><a href="global.html#setRandomSong">setRandomSong</a></li><li><a href="global.html#showByHash">showByHash</a></li><li><a href="global.html#tmpCopy">tmpCopy</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc</a>.
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
